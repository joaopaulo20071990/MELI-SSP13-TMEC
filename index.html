<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8">
<title>TMEC - MERCADO LIVRE</title>
<style>
/* ...SEU CSS PADRÃO, igual às versões anteriores... */
body {
    background: #f5f8fd;
    font-family: 'Segoe UI', Arial, sans-serif;
    margin: 0;
}
.header {
    background: #fcc831;
    width: 100%;
    padding: 35px 0 32px 0;
    font-size: 2.5rem;
    font-weight: bold;
    text-align: center;
    letter-spacing: 2px;
    color: #fff;
    text-shadow: 1px 2px 8px #c9a70d56;
    box-shadow: 0 2px 12px #e4c57066;
    margin-bottom: 0;
}
/* ...demais estilos iguais ao layout anterior (cortei para foco no JS/Firebase)... */
.counter-timer {
    position: absolute; right: 32px; bottom: 75px; font-size: 1.43rem;
    color: #2260a8; font-weight: bold; letter-spacing: 2px; text-align: right;
    text-shadow: 1px 2px 6px #fff9, 0 1px 0 #65656517;
    font-family: "Courier New", monospace;
}
</style>
<!-- Firebase SDKs -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
<script>
const firebaseConfig = {
  apiKey: "AIzaSyAL2cbdQsvM6S0HbAytGsNE3YQjpStBbD8",
  authDomain: "ssp13-tmec.firebaseapp.com",
  databaseURL: "https://ssp13-tmec-default-rtdb.firebaseio.com",
  projectId: "ssp13-tmec",
  storageBucket: "ssp13-tmec.firebasestorage.app",
  messagingSenderId: "342683543158",
  appId: "1:342683543158:web:050a7b3408cf238337a157",
  measurementId: "G-6CEWQNV9VX"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();
</script>
</head>
<body>
<div class="header">TMEC - MERCADO LIVRE</div>
<div class="top-bar">
    <div class="filtros-bloco">
        <span class="filtro-label">Transportadora:</span>
        <select class="filter-select" id="filtroTransportadora">
            <option value="">Todas</option>
            <option>ALC</option>
            <option>MURICI</option>
            <option>TORRES</option>
            <option>UNICA</option>
            <option>KANGU</option>
            <option>BLD</option>
        </select>
        <span class="filtro-label">SVC:</span>
        <input class="filter-svc" id="filtroSVC" placeholder="Digite o SVC">
    </div>
    <button class="btn-yellow" id="novoContador">Novo Contador</button>
    <input type="text" id="inputQrManual" class="campo-qr" placeholder="Cole SVC;PLACA;TRANSPORT." autocomplete="off">
    <button class="ok-btn" id="enviarQrManual">OK</button>
</div>
<div class="counters-area" id="countersArea"></div>
<!-- Histórico Finalizados -->
<div class="historico-area" id="historicoArea" style="display:none;">
    <div class="historico-flexbar">
        <div class="historico-title">Histórico de Finalizados</div>
        <button class="btn-historico-csv" id="btnBaixarCSV">Baixar Histórico</button>
    </div>
    <table class="historico-table" id="historicoTable">
        <thead>
            <tr>
                <th>SVC</th>
                <th>Placa</th>
                <th>Transportadora</th>
                <th>Hora início</th>
                <th>Hora final</th>
                <th>Tempo percorrido</th>
            </tr>
        </thead>
        <tbody id="historicoTbody"></tbody>
    </table>
</div>
<div class="popup-bg" id="popupBg">
    <form class="popup-form" id="formEntrada" autocomplete="off" onsubmit="return false">
        <label for="formSVC">SVC:</label>
        <input class="input-svc" id="formSVC" placeholder="Digite o SVC" required>
        <label for="formPlaca">Placa:</label>
        <input class="input-placa" id="formPlaca" placeholder="Digite a placa" required>
        <label for="formTransportadora">Transportadora:</label>
        <select class="input-transp" id="formTransportadora" required>
            <option value="">Selecione</option>
            <option>ALC</option>
            <option>MURICI</option>
            <option>TORRES</option>
            <option>UNICA</option>
            <option>KANGU</option>
            <option>BLD</option>
        </select>
        <button class="btn-form-yellow" id="btnRegistrar">Registrar Entrada</button>
        <button class="btn-cancelar" id="btnCancelar" type="button">Cancelar</button>
    </form>
</div>
<script>
let cartas = [];
function criarCard(svc, placa, transportadora) {
    const card = document.createElement('div');
    card.className = "counter-card";
    card.setAttribute('data-transportadora', transportadora);
    card.setAttribute('data-svc', svc.toLowerCase());
    const dtInicio = new Date();
    const horaInicio = getHoraMinSeg(dtInicio);
    card.innerHTML = `
        <label>SVC:</label>
        <div class="card-svc">${svc}</div>
        <label>Placa:</label>
        <div class="card-placa">${placa}</div>
        <div class="counter-transport"><label>Transportadora:</label><span>${transportadora}</span></div>
        <div class="inicio-quadro"><label>Início:</label><span class="inicio-hora">${horaInicio}</span></div>
        <div class="counter-timer">00:00:00</div>
        <button class="btn-finalizar">Finalizar</button>
    `;
    document.getElementById('countersArea').appendChild(card);
    const timerEl = card.querySelector('.counter-timer');
    const finalizarBtn = card.querySelector('.btn-finalizar');
    // CONTADOR POR TEMPO REAL
    const startTime = Date.now();
    card.classList.add('time-green');
    // Envia para o Firebase!
    const idContador = Date.now().toString() + Math.floor(Math.random()*100000);
    db.ref('contadoresAtivos/' + idContador).set({
        svc, placa, transportadora, horaInicio, id: idContador
    });
    let intervalId = setInterval(()=>{
        let delta = Math.floor((Date.now() - startTime) / 1000);
        timerEl.textContent = formatTimer(delta);
        card.classList.remove('time-green','time-yellow','time-red');
        if(delta < 900)         card.classList.add("time-green");
        else if(delta < 1500)   card.classList.add("time-yellow");
        else                    card.classList.add("time-red");
    },1000);
    finalizarBtn.addEventListener('click', function(){
        clearInterval(intervalId);
        let delta = Math.floor((Date.now() - startTime) / 1000);
        timerEl.textContent = formatTimer(delta);
        finalizarBtn.style.display = "none";
        const dtFim = new Date();
        const horaFinal = getHoraMinSeg(dtFim);
        adicionarHistorico({
            svc, placa, transportadora, horaInicio, horaFinal, tempoPercorrido: formatTimer(delta)
        });
        // Remove do Firebase!
        db.ref('contadoresAtivos/' + idContador).remove();
        card.remove();
    });
    cartas.push(card);
}
function formatTimer(segundos) {
    const h = String(Math.floor(segundos/3600)).padStart(2,'0');
    const m = String(Math.floor((segundos%3600)/60)).padStart(2,'0');
    const s = String(segundos%60).padStart(2,'0');
    return `${h}:${m}:${s}`;
}
function getHoraMinSeg(dt) {
    return String(dt.getHours()).padStart(2,'0') + ":" +
           String(dt.getMinutes()).padStart(2,'0') + ":" +
           String(dt.getSeconds()).padStart(2,'0');
}
function adicionarHistorico(obj) {
    document.getElementById('historicoArea').style.display = '';
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${obj.svc}</td>
       <td>${obj.placa}</td>
       <td>${obj.transportadora}</td>
       <td>${obj.horaInicio}</td>
       <td>${obj.horaFinal}</td>
       <td>${obj.tempoPercorrido}</td>`;
    document.getElementById('historicoTbody').appendChild(tr);
}
document.getElementById('btnRegistrar').addEventListener('click', function(e){
    e.preventDefault();
    const svc = document.getElementById('formSVC').value.trim();
    const placa = document.getElementById('formPlaca').value.trim();
    const transportadora = document.getElementById('formTransportadora').value;
    if(!svc || !placa || !transportadora) { alert("Preencha todos os campos!"); return; }
    criarCard(svc, placa, transportadora);
    fecharPopup();
    aplicarFiltro();
});
document.getElementById('novoContador').addEventListener('click', mostrarPopup);
document.getElementById('btnCancelar').addEventListener('click', fecharPopup);
document.getElementById('filtroTransportadora').addEventListener('change', aplicarFiltro);
document.getElementById('filtroSVC').addEventListener('input', aplicarFiltro);
function aplicarFiltro() {
    const filtroTransp = document.getElementById('filtroTransportadora').value;
    const filtroSVC = document.getElementById('filtroSVC').value.trim().toLowerCase();
    cartas.forEach(card => {
        const cardTransp = card.getAttribute('data-transportadora');
        const cardSVC = card.getAttribute('data-svc');
        let okTransp = !filtroTransp || (cardTransp === filtroTransp);
        let okSVC = !filtroSVC || (cardSVC.indexOf(filtroSVC) !== -1);
        card.style.display = (okTransp && okSVC) ? '' : 'none';
    });
}
document.getElementById("inputQrManual").addEventListener("keydown", function(e){
    if(e.key==="Enter"){ e.preventDefault(); processarManualQR(); }
});
document.getElementById("enviarQrManual").addEventListener("click", processarManualQR);
function processarManualQR(){
    let val = document.getElementById("inputQrManual").value.trim();
    if(!val.includes(";")){
        alert("O padrão deve ser: SVC;PLACA;TRANSPORTADORA");
        return;
    }
    let [svc, placa, transportadora] = val.split(";").map(x=>x.trim());
    const validas = ["ALC","MURICI","TORRES","UNICA","KANGU","BLD"];
    if(!svc || !placa || !transportadora || !validas.includes(transportadora.toUpperCase())) {
        alert("Dados inválidos!");
        return;
    }
    criarCard(svc, placa, transportadora.toUpperCase());
    document.getElementById("inputQrManual").value = "";
}
function mostrarPopup() {
    document.getElementById('popupBg').classList.add('popup-show');
    document.getElementById('formEntrada').reset();
    document.getElementById('formSVC').focus();
}
function fecharPopup() {
    document.getElementById('popupBg').classList.remove('popup-show');
}
// ...BAIXAR CSV permanece igual...
document.getElementById('btnBaixarCSV').addEventListener('click', function() {
    let csv = 'SVC,Placa,Transportadora,Hora início,Hora final,Tempo percorrido\n';
    const linhas = document.querySelectorAll('#historicoTbody tr');
    if (linhas.length === 0) {
        alert('Nenhum registro no histórico!');
        return;
    }
    linhas.forEach(tr => {
        const tds = tr.querySelectorAll('td');
        let row = [];
        tds.forEach(td => {
            let texto = td.textContent.replace(/"/g,'""').replace(/\n/g, ' ').replace(/,/g, ' ');
            row.push('"' + texto + '"');
        });
        csv += row.join(',') + '\n';
    });
    const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement("a");
    link.href = URL.createObjectURL(blob);
    link.download = "historico_finalizados.csv";
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
});
</script>
</body>
</html>