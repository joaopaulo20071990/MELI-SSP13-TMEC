<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8">
  <title>Visualização Dispachers</title>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
  <style>
    body {
      background: #f5f8fd;
      font-family: 'Segoe UI', Arial, sans-serif;
      margin: 0;
    }
    .header {
      background: #fcc831;
      width: 100%;
      padding: 35px 0 32px 0;
      font-size: 2.3rem;
      font-weight: bold;
      text-align: center;
      letter-spacing: 2px;
      color: #fff;
      text-shadow: 1px 2px 8px #c9a70d56;
      box-shadow: 0 2px 12px #e4c57066;
      margin-bottom: 0;
    }
    .top-bar {
      width: 100%;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 36px 0 16px 0;
      gap: 16px;
      flex-wrap: wrap;
    }
    .filtros-bloco {
      display: flex; align-items: center; gap: 10px;
      background: #fff7;
      border-radius: 16px;
      padding: 10px 22px;
      box-shadow: 0 2px 6px #fce88d2b;
      margin-right: 10px;
    }
    .filtro-label {
      color: #2176b8;
      font-weight: 600;
      font-size: 1.15rem;
    }
    .filter-select, .filter-svc {
      border-radius: 13px;
      border: none;
      background: #f7fbfd;
      color: #24515a;
      padding: 8px 16px;
      font-size: 1.13rem;
      font-weight: 500;
      box-shadow: 0 2px 5px #e2eef4ab;
    }
    .filter-svc::placeholder { color: #b0b0b0; font-weight: normal; }
    .counters-area {
      width: 100%;
      display: flex;
      flex-direction: row;
      flex-wrap: wrap;
      align-items: flex-start;
      justify-content: flex-start;
      gap: 36px;
      min-height: 90px;
      margin-bottom: 58px;
      padding: 16px 38px 0 38px;
    }
    .counter-card {
        min-width: 370px; max-width: 380px;
        padding: 23px 28px 92px 28px;
        border-radius: 24px;
        box-sizing: border-box;
        display: flex; flex-direction: column; position: relative;
        margin-bottom: 12px;
        box-shadow: 0 7px 32px #e0f6ff29;
        border: 3px dashed #31a1cc;
        background: #e6f2fc;
        transition: background 0.6s, border-color .3s;
    }
    .counter-card.time-green {
        border-color: #31d378;
        background: #e6faec;
    }
    .counter-card.time-yellow {
        border-color: #ffe174;
        background: #fffbe6;
    }
    .counter-card.time-red {
        border-color: #ef6d6d;
        background: #ffeaea;
    }
    .counter-card label {
        color: #2176b8;
        font-weight: 600;
        font-size: 1.16rem;
        margin-top: 9px;
        margin-bottom: 2.5px;
        display: block;
    }
    .counter-card label:first-child {margin-top:0;}
    .card-svc, .card-placa {
        background: #222c32;
        color: #fff;
        font-weight: bold;
        padding: 14px 13px 13px 16px;
        border-radius: 10px;
        width: 100%;
        font-size: 1.32em;
        margin-bottom: 11px;
        box-shadow:0 2px 9px #2a2c3042;
        letter-spacing: 0.19em;
        border: none;
        text-shadow: 0 2px 5px #000a;
        font-family: "Segoe UI", "Arial Black", Arial, sans-serif;
    }
    .card-placa {margin-bottom: 19px;}
    .counter-transport label { color: #1976d2; font-size:1.08em;}
    .counter-transport span { color: #30679e; font-weight: 500; font-size: 1.06rem; display: block; margin-top: 2px; margin-bottom: 0;}
    .inicio-quadro label {color: #2176b8; font-weight: bold; font-size: 1.09em; margin-bottom: 2px;}
    .inicio-hora { color: #1976d2; margin-left: 8px; font-weight: bold; font-size: 1.12rem; font-family: monospace;}
    .counter-timer {
        position: absolute; right: 32px; bottom: 75px; font-size: 1.41rem;
        color: #2260a8; font-weight: bold; letter-spacing: 2px; text-align: right;
        text-shadow: 1px 2px 6px #fff9, 0 1px 0 #65656517;
        font-family: "Courier New", monospace;
    }
    .historico-area {display:block; margin:0 auto 32px auto; padding-left:54px; width:96vw; max-width:1100px;}
    .historico-flexbar {display:flex;align-items:center;justify-content:space-between;margin-bottom:12px;gap:8px;}
    .historico-title { color: #146ba7; font-size: 1.19rem; font-weight: bold; letter-spacing: 0.5px; margin-bottom:0;}
    .btn-historico-csv {
        background: #22b368;
        color: #fff;
        font-weight: bold;
        border: none;
        border-radius: 13px;
        padding: 13px 36px;
        font-size: 1.13rem;
        box-shadow: 0 2px 6px #65cf9d5b;
        cursor: pointer;
        transition: background .15s;
    }
    .btn-historico-csv:hover {background: #177d43;}
    table.historico-table { width: 100%; border-collapse: collapse; background: #f7fbfd; border-radius: 14px; overflow: hidden; font-size: 1.09em;}
    table.historico-table th, table.historico-table td {
        border-bottom: 1px solid #cce3f7;
        text-align: center;
        padding: 11px 7px;
    }
    table.historico-table th { background: #e6f2fc; color: #2176b8; font-weight: bold; padding: 16px 5px; font-size: 1.06rem; border-bottom: 2.2px solid #3aa6d1;}
    table.historico-table tr:nth-child(even) td { background: #f3f7fd;}
    table.historico-table tr:last-child td { border-bottom: none; }
  </style>
</head>
<body>
<div class="header">VISUALIZAÇÃO DISPACHERS</div>
<div class="top-bar">
    <div class="filtros-bloco">
        <span class="filtro-label">Transportadora:</span>
        <select class="filter-select" id="filtroTransportadora">
            <option value="">Todas</option>
            <option>ALC</option>
            <option>MURICI</option>
            <option>TORRES</option>
            <option>UNICA</option>
            <option>KANGU</option>
            <option>BLD</option>
        </select>
        <span class="filtro-label">SVC:</span>
        <input class="filter-svc" id="filtroSVC" placeholder="Digite o SVC">
    </div>
</div>
<div class="counters-area" id="countersArea"></div>

<div class="historico-area" id="historicoArea" style="display:block;">
    <div class="historico-flexbar">
        <div class="historico-title">Histórico de Finalizados</div>
        <button class="btn-historico-csv" id="btnBaixarCSV">Baixar Histórico</button>
    </div>
    <table class="historico-table" id="historicoTable">
        <thead>
            <tr>
                <th>SVC</th>
                <th>Placa</th>
                <th>Transportadora</th>
                <th>Hora início</th>
                <th>Hora final</th>
                <th>Tempo percorrido</th>
            </tr>
        </thead>
        <tbody id="historicoTbody"></tbody>
    </table>
</div>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyAL2cbdQsvM6S0HbAytGsNE3YQjpStBbD8",
  authDomain: "ssp13-tmec.firebaseapp.com",
  databaseURL: "https://ssp13-tmec-default-rtdb.firebaseio.com",
  projectId: "ssp13-tmec",
  storageBucket: "ssp13-tmec.firebasestorage.app",
  messagingSenderId: "342683543158",
  appId: "1:342683543158:web:050a7b3408cf238337a157",
  measurementId: "G-6CEWQNV9VX"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

let cartas = {};

function getHoraMinSeg(dt) {
    return String(dt.getHours()).padStart(2,'0') + ":" +
           String(dt.getMinutes()).padStart(2,'0') + ":" +
           String(dt.getSeconds()).padStart(2,'0');
}
function formatTimer(s) {
    const h = String(Math.floor(s/3600)).padStart(2,'0');
    const m = String(Math.floor((s%3600)/60)).padStart(2,'0');
    const sec = String(s%60).padStart(2,'0');
    return `${h}:${m}:${sec}`;
}

// ---------- LISTA CONTADORES ATIVOS ----------
function renderContadoresOnline(data){
    const area = document.getElementById('countersArea');
    area.innerHTML = '';
    cartas = {};
    for(const [id,info] of Object.entries(data||{})){
        let card = document.createElement('div');
        card.className = 'counter-card time-green';
        card.innerHTML = `
            <label>SVC:</label>
            <div class="card-svc">${info.svc}</div>
            <label>Placa:</label>
            <div class="card-placa">${info.placa}</div>
            <div class="counter-transport"><label>Transportadora:</label><span>${info.transportadora}</span></div>
            <div class="inicio-quadro"><label>Início:</label><span class="inicio-hora">${info.horaInicio}</span></div>
            <div class="counter-timer" id="timer${id}">00:00:00</div>
        `;
        card.setAttribute('data-transportadora', info.transportadora);
        card.setAttribute('data-svc', info.svc.toLowerCase());
        area.appendChild(card);

        function segundosDesde(hhmmss) {
            const [h,m,s] = hhmmss.split(":").map(Number);
            const agora = new Date();
            const segsAgora = agora.getHours()*3600 + agora.getMinutes()*60 + agora.getSeconds();
            const segsIni = h*3600 + m*60 + s;
            let delta = segsAgora-segsIni;
            if(delta<0) delta+=86400;
            return delta;
        }
        const timerEl = card.querySelector('.counter-timer');
        function updateTimer(){
            let segs = segundosDesde(info.horaInicio);
            timerEl.textContent = formatTimer(segs);
            card.classList.remove('time-green','time-yellow','time-red');
            if(segs < 900) card.classList.add('time-green');
            else if(segs < 1500) card.classList.add('time-yellow');
            else card.classList.add('time-red');
        }
        updateTimer();
        setInterval(updateTimer,1000);
        cartas[id] = card;
    }
    aplicarFiltro();
}

db.ref('contadoresAtivos').on('value', snap => {
    renderContadoresOnline(snap.val());
});

// ---------- HISTÓRICO FINALIZADOS ----------
db.ref('historicoFinalizados').on('value', snap => {
    renderHistoricoOnline(snap.val());
});

function renderHistoricoOnline(data) {
    let tbody = document.getElementById('historicoTbody');
    tbody.innerHTML = '';
    if (data) {
        Object.values(data).forEach(obj => {
            const tr = document.createElement('tr');
            tr.innerHTML = `<td>${obj.svc}</td>
               <td>${obj.placa}</td>
               <td>${obj.transportadora}</td>
               <td>${obj.horaInicio}</td>
               <td>${obj.horaFinal}</td>
               <td>${obj.tempoPercorrido}</td>`;
            tbody.appendChild(tr);
        });
    }
}

// ---------- FILTROS ----------
document.getElementById('filtroTransportadora').addEventListener('change', aplicarFiltro);
document.getElementById('filtroSVC').addEventListener('input', aplicarFiltro);

function aplicarFiltro() {
    const trans = document.getElementById('filtroTransportadora').value;
    const svc = document.getElementById('filtroSVC').value.trim().toLowerCase();
    Object.values(cartas).forEach(card=>{
        let okTrans = !trans || card.getAttribute('data-transportadora')===trans;
        let okSvc = !svc || card.getAttribute('data-svc').includes(svc);
        card.style.display = (okTrans && okSvc)?'':'none';
    });
}

// --------- BAIXAR HISTÓRICO EM CSV ----------
document.getElementById('btnBaixarCSV').addEventListener('click', function() {
    let csv = 'SVC,Placa,Transportadora,Hora início,Hora final,Tempo percorrido\n';
    const linhas = document.querySelectorAll('#historicoTbody tr');
    if (linhas.length === 0) {
        alert('Nenhum registro no histórico!');
        return;
    }
    linhas.forEach(tr => {
        const tds = tr.querySelectorAll('td');
        let row = [];
        tds.forEach(td => {
            let texto = td.textContent.replace(/"/g,'""').replace(/\n/g, ' ').replace(/,/g, ' ');
            row.push('"' + texto + '"');
        });
        csv += row.join(',') + '\n';
    });
    const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement("a");
    link.href = URL.createObjectURL(blob);
    link.download = "historico_finalizados.csv";
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
});
</script>
</body>
</html>